# 采样

#### （1）重要性采样

重要性采样的目标：通过改变采样分布来减少方差，从而提高估计的精度

- 期望的等价转换

  当计算某个函数的期望时，假设变量x符合某个分布p(x)，但分布p(x)往往难以直接采样；我们可以选取另一个容易进行采样的分布q(x)：
  $$
  \begin{array}{c}
  E_{x\sim p}[f(x)]=\int_x f(x)p(x)\text{d}x=\int_x f(x)\frac{p(x)}{q(x)}q(x)\text{d}x=E_{x\sim q}[f(x)\frac{p(x)}{q(x)}]
  \\ \therefore E_{x\sim p}[f(x)]=E_{x\sim q}[f(x)\frac{p(x)}{q(x)}]
  \end{array}
  $$
  这一步骤说明在不同分布下采样，通过加权可以得到相同的期望，权值/重要性即为"p(x)/q(x)"

- 蒙特卡洛估计

  通过从q(x)中采样N个点，期望值的蒙特卡洛估计为：
  $$
  E_{x\sim p}[f(x)]\approx \frac{1}{N}\sum_{i=1}^N \frac{p(x_i)}{q(x_i)}f(x_i)
  $$
  🏆**关键在于不等式≈在什么情况下接近于等式！**⇒ 为了确保估计的准确性，我们需要最小化估计值的方差：
  $$
  \min \ Var(\frac{f(x)p(x)}{q(x)})
  $$
  为什么方差较小时，采样的估计值越接近真实的期望值？有两种理解方式：(1)当方差较小时，意味着估计值在不同的样本集上波动较小，因此更接近其期望值 (2)利用切比雪夫不等式证明：
  $$
  \begin{array}{c}
  \text{Pr}(|X-\mu|\ge k\sigma)\le \frac{1}{k^2}
  \\ \text{Pr}(|\hat{I}_{IS}-I|\ge k\sqrt{\frac{Var(h(x))}{N}})\le \frac{1}{k^2}
  \end{array}
  $$
  当N增加，或者方差减少，估计值越接近于期望值

- 最小化方差

  我们知道常数的方差为0，当q(x)与|f(x)p(x)|成正比关系时，方差最小
  $$
  \\ q(x)\propto |f(x)p(x)| \ \ \ \rightarrow\ \ \ \min Var(c) _{[c为常数]}
  $$

总结：重要性采样阐述了如何选择合适的采样方式，使得估计期望值更加准确

#### （2）蒙特卡洛积分

- 求解定积分

  在实际应用中，我们往往需要求解函数的定积分(蒙特卡洛积分)：
  $$
  \int f(x)dx=E_{x\sim p}[\frac{f(x)}{p(x)}]\approx \frac{1}{N}\sum_{i=1}^N\frac{f(x_i)}{q(x_i)}
  $$
  此时，我们只需要选择合适的分布q(x)，使得q(x)与|f(x)|成正比

- 通过期望证明
  $$
  \begin{array}{c}
  E(\frac{f(x)}{p(x)})=\int\frac{f(x)}{p(x)}p(x)\text{d}x=\int f(x)\text{d}x
  \\ \because E(\frac{f(x)}{p(x)})\approx \frac{1}{N} \sum_{i=1}^n \frac{f(x_i)}
  {p(x_i)}
  \\ \therefore \int f(x)\text{d}x\approx \frac{1}{N} \sum_{i=1}^n \frac{f(x_i)}
  {p(x_i)}
  \end{array}
  $$
  在上述过程中，通过选择另一个容易进行采样的分布q(x)，假设了q(x)与|p(x)|存在正比关系，即可将q(x)等价替换上述过程中的p(x)

- 蒙特卡洛积分的理解

  在求解定积分时，不同区间段对积分值的贡献应是均等的。然而，由于概率分布(采样)的影响，选取的采样点往往集中在概率密度较大的区域，使得积分值偏向该区域。为了消除这种偏差，需要将f(x)除以p(x)，即调整每个采样点的权重{💡个人认为，这是一种快速理解和记忆蒙特卡洛积分的好方法}

**综上：我们根据目标函数的分布选择相似的采样分布，以提高估计的精度**

#### （3）逆变换采样

逆变换采样：是一种**为任意概率分布生成随机样本**的技术 → 将均匀分布的随机数u映射到目标分布f(x)上，其中映射函数为累积分布函数(cdf)的反函数F<sup>-1</sup>。也就是说，新构造的随机变量X可以表示为F<sup>-1</sup>(u)，认为这个新变量X的分布与目标分布一致

> 相关博客：https://zhuanlan.zhihu.com/p/622443806

- 证明过程：

  我们假设变量u在[0,1]上均匀线性随机分布，通过映射函数F<sup>-1</sup>得到新的变量X，即
  $$
  u\sim U(0,1)
  \\ X=F^{-1}(u)
  \\ \text{其中,累积分布函数F(x)定义为:}\ F(x)=\int_{-\infty}^x f(t)\text{d}t
  $$
  我们需要验证新变量X与原始变量x具有相同的分布，这可以通过累积分布函数(CDF)进行推导，新变量X的累积分布函数为：
  $$
  F_X(x)=P(X\le x)
  \\ = P(F^{-1}(u)\le x)
  $$
  利用累积分布函数F的单调递增特性(反函数F<sup>-1</sup>也必定单调递增)，因此：
  $$
  =P(u\le F(x))
  $$
  又利用u的均匀分布性质，u的累积分布函数为y=x，有：
  $$
  \because P(u\le u)=u
  $$
  所以：
  $$
  =P(u\le F(x))=F(x)
  \\ \therefore F_X(x)=F(x)
  $$
  综上，证明了随机变量X=F<sup>-1</sup>(u)的累积分布函数F<sub>X</sub>(x)与目标累积分布函数F(x)一致。因此，利用逆变换采样生成的随机变量X确实服从目标概率分布f(x)

- 使用步骤：

  1. 已知概率密度函数(PDF) → p(x) 或者 f(x)

  2. 求累积分布函数(CDF) → F(x) 
     $$
     F(x)=\int_{-\infty}^x f(t)\text{d}t
     $$

  3. 求累积分布函数的反函数 → F<sup>-1</sup>(u)

  4. 生成均匀分布的随机数 → u ~ U(0, 1)

  5. 通过逆函数映射生成样本 → X = F<sup>-1</sup>(u)

综上所述：逆变换采样是一种非常通用的随机样本生成算法。在已知PDF或CDF的情况下，通过线性随机数和逆函数映射的方法，可以生成指定分布的随机样本。

#### （4）常见采样方式

在图形学中，采样技术的应用主要集中在求解渲染方程过程中。渲染方程通过对着色点的入射半球进行采样。采样分布的选择往往依赖于积分的函数f(x)，而渲染方程中的f(x)包括光源项、BRDF项、余弦项等。根据不同情况，衍生出了如下常见的采样方式：

- 半球均匀采样
- 余弦加权的半球采样 → 基于朗伯余弦定理
- GGX采样 → 基于GGX法线分布
- ...

#### （5）半球均匀采样

> 参考链接：https://www.bogotobogo.com/Algorithms/uniform_distribution_sphere.php

半球均匀采样

- 步骤

  对θ、𝞿分别取线性随机数，各采样点权重为1/(2𝜋)，即1/总表面积

- 特征

  采样点在半球上是均匀分布的，点与点之间的距离也是最大且均匀的

- 推导

  采样点在半球上是均匀分布的，即采样点在其表面积上或者单位立体角上均匀分布，dω=sinθdθd𝜑

  如果尝试只使用线性均匀的θ对采样点进行描述，那么大部分采样点会集中在球面的极点处，两种理解：(1)dω中存在sinθ (2)θ描述的是纬度，不同的θ角对应的纬圈长度不同，在赤道处纬圈最长，在极点处最短，如果对)θ进行线性分布，由于长度的差异，极点附近的点密度远高于赤道附近的点密度，这就导致了采样点在极点附近聚集

  阿基米德定理表明，如果在某一高度h处切割球体，切割部分的表面积等于将球体包围在一个圆柱体中时，对应投影区域在圆柱体上的侧面积 → 这暗示着：我们在圆柱体上生成随机点[-1,1]×[0,2𝜋]，再逆投影回单位球

  <img src="https://cdn.jsdelivr.net/gh/shuaigougou5545/blog-image/img/202405201316861.png" alt="CircumscribeCylinder" style="zoom:70%;" />
  $$
  S_1=S_2=2\pi Rh
  $$
  TODO：联合概率密度、边缘概率密度

  

#### （5）余弦加权的半球采样

#### （6）GGX采样